import time, sys, os

import xlsxwriter

sys.path.append(os.path.abspath('../'))
from core.schema import *
from core.mysql import Session, engine, session_scope
from numba import jit
from sqlalchemy import func


def row2dict(row):
    d = {}
    for column in row.__table__.columns:
        d[column.name] = str(getattr(row, column.name))

    return d


class TD:
    # 将拆分表每日数据导出成xls

    def __init__(self, raw):
        self.session = Session()
        self.raw = raw
        self.position_map = {}
        self.position_set = set()

    def get_total(self, day):
        # return self.session.query(DailyHrCrawl).offset(offset).limit(limit).yield_per(1000)
        total = self.session.query(func.count(DailyHrCrawl.id)).filter(
            DailyHrCrawl.created >= '{} 00:00:00'.format(day),
            DailyHrCrawl.created <= '{} 23:59:59'.format(day),
        ).scalar()
        return total

    def get_day_record(self, day):
        # return self.session.query(DailyHrCrawl).filter(
        #     DailyHrCrawl.created >= '{} 00:00:00'.format(day),
        #     DailyHrCrawl.created <= '{} 23:59:59'.format(day),
        #     # ).offset(offset).limit(limit).yield_per(1000)
        # ).
        sql = """SELECT 
p.position as position, count(DISTINCT(d.jx_resume_id)) as num 
from
daily_crawl_hr_58_record as d 
left join
position_tag as p on p.id=d.tag_id 
WHERE 
d.is_today_update=1 
and d.created > '{} 00:00:00' 
and  d.created <'{} 23:59:59'  

group by d.tag_id 
order by num desc
""".format(day, day)
        result = self.session.execute(sql)
        # self.session.commit()
        return {name: v for name, v in result}

        # return dict((zip(result.keys(), result)))

    # def get_day_record_1(self, day):
    #     query = self.session.query(func.count(DailyHrCrawlNew.jx_resume_id), )

    def get_all_line(self):
        return self.raw.split('\n')

    @jit
    def reshape_day_record(self, base_row_names, day_record):
        # 转换天的记录
        day_col = []
        for name in base_row_names:
            if name in day_record:
                day_col.append(day_record[name])
            else:
                day_col.append(0)
        return day_col

    def save_xls(self, days, col_list, name):
        # with open(name, 'wb') as f:

        workbook = xlsxwriter.Workbook(name)
        worksheet = workbook.add_worksheet()
        worksheet.set_default_row(20)
        column_title = [''] + days
        worksheet.set_column(0, len(column_title) - 2, 20)
        for i in range(len(column_title)):
            worksheet.write(0, i, column_title[i])

        # col = 1
        # cols = len(col_list)
        # lines = len(col_list[0])
        for r_index, one_col in enumerate(col_list):
            for c_index, one in enumerate(one_col):
                worksheet.write(c_index + 1, r_index, one)

        workbook.close()

    def run(self):
        # 获取旧的简历
        all_row_names = self.get_all_line()
        print(len(all_row_names))

        cols = [all_row_names]

        days = [
            '2019-09-19',
            '2019-09-20',
            '2019-09-21',
            '2019-09-22',
            '2019-09-23',
            '2019-09-24',
            '2019-09-25',
            '2019-09-26',
            '2019-09-27',
            '2019-09-28'
        ]

        for day in days:
            # day = '2019-09-28'
            day_record = self.get_day_record(day)
            # print(day_record)
            ok_day_record = self.reshape_day_record(all_row_names, day_record)
            print(len(ok_day_record))
            cols.append(ok_day_record)
            # break

        self.save_xls(days, cols, './test.xls')


if __name__ == '__main__':
    # all day
    """
    2019-07-15
2019-07-16
2019-07-17
2019-07-18
2019-07-19
2019-07-20
2019-07-21
2019-08-03
2019-08-04
2019-08-05
2019-08-06
2019-08-09
2019-08-14
2019-08-15
2019-08-16
2019-08-17
2019-08-18
2019-08-19
2019-08-20
2019-08-21
2019-08-22
2019-08-23
2019-08-24
2019-08-25
2019-08-26
2019-08-27
2019-08-28
2019-08-29
2019-09-19
2019-09-20
2019-09-21
2019-09-22
2019-09-23
2019-09-24
2019-09-25
2019-09-26
2019-09-27
    """
    raw = """货运司机
商务司机
文员
店员/营业员
普工
其他职位
保安
厨师/厨师长
服务员
销售代表
收银员
仓库管理员
淘宝客服
促销/导购员
前台/总机/接待
人事专员/助理
客服专员/助理
行政专员/助理
教师/助教
会计/会计师
财务/会计助理
快递员
专车司机
网络销售
幼教
后厨
后勤
保洁
护士/护理
出纳
销售经理/主管
电话客服
理货员/陈列员
电工
网络/在线客服
物业管理/商业中心
学徒
装卸/搬运工
餐饮管理
前台/接待
分拣员
切割/焊工
电话销售
平面设计
销售助理
物流专员/助理
特种车司机
木工
售前/售后服务
送餐员
面点师
美容师
代驾司机
娱乐厅服务员
内勤人员
店长/卖场经理
家教
出租车司机
保姆
配菜/打荷
美甲师
化妆师
文档/资料管理
发型师
人事经理/主管
工程项目管理
综合维修工
操作工
客运司机
运动/健身教练
施工员
酒吧服务员
足疗保健
缝纫工
油漆工
网店运营
汽车销售
行政经理/主管
钟点工
推拿按摩
仓库经理/主管
图书管理员
大堂经理/领班
采购员
经理助理/秘书
区域销售
物业经理/主管
音乐/美术教师
客房服务员
班车司机
传菜员
资料员
西点师
铲车/叉车工
育婴师/保育员
淘宝美工
医生
招聘专员/助理
烧烤师
汽车美容
车工/铣工
汽车修理工
驾校教练/陪练
美容助理/学徒
舞蹈老师
CAD设计/制图
摄影师/摄像师
旅游顾问
电脑操作/打字/录入员
教学/教务管理
生产主管/组长
小学老师
财务经理/主管
物流经理/主管
招生/课程顾问
咖啡师
制冷/水暖工
迎宾/接待
统计员
装修装潢设计
订票员
包装工
造价师/预算师
兼职教师
物业维修
网络管理员
技术支持/维护
月嫂
餐厅服务员
工程监理
钳工
采购助理
培训师/讲师
客服经理/主管
美发助理/学徒
质量检验员/测试员
督导
铸造/注塑/模具工
礼仪/迎宾
杂工
茶艺师
家具/家居用品设计
洗碗工
厨工
建筑施工现场管理
酒店店长
广告设计
美容整形师
销售总监
医药代表
奢侈品业务
组装工
影视/后期制作
调度员
车间主任
美容导师
理疗师
培训助理
游戏设计/开发
CNC/数控工程师
汽车/摩托车修理
质量管理
技术工程师
测绘/测量
导游/计调
钣金工
市场专员/助理
三维/3D设计/制作
服装打样/制版
厂长/副厂长
室内装潢设计
学徒工
土木/土建工程师
主持人
针灸推拿
渠道专员
美容/瘦身顾问
招商经理/主管
安全管理/安全员
样衣工
风险管理/控制
护工
网店店长
农艺师
安检员
安全消防
生产计划
品类管理
外贸专员/助理
网络推广
电子/电器维修
物料管理
总裁助理/总经理助理
厨师助理/学徒
编辑/撰稿
导医
配音员
地勤人员
房产经纪人
楼层经理
美编/美术设计
促销/导购
客房部经理
防损员/内保
薪酬/绩效/员工关系
市场营销
电子/电气工程师
税务专员/助理
签约艺人
销售支持
预订员
初中教师
美容店长
客户咨询热线/呼叫中心人员
培训专员/助理
审计专员/助理
置业顾问
客户关系管理
销售业务跟单
前厅部员工
客服
机电/机械工程师
录入/校对
综合布线/弱电
供应链管理
药剂师
活动策划
医疗器械销售
4S店管理
单证员
客户经理/主管
电路工程师/技术员
调酒师
生产运营管理
项目经理/主管
会计经理/主管
施工队长
放映员
机械工程师
食品加工/处理
网站运营
制作执行
建筑工程师/总工
英语翻译
贸易跟单
监控维护
多媒体/动画设计
前台主管
宠物美容/护理
医疗管理
万能工
总监
养殖人员
形象设计师
淘宝其他
体育老师/教练
外语教师
采购经理/总监
理科教师
软件工程师
网页设计/制作
视觉设计
分公司经理
旅游产品/线路策划
产品/包装设计
招聘经理/主管
其他兼职
生产管理
排版设计/制作
计调
前厅部经理
美术指导
成本管理员
设备管理维护
裁剪工
手机维修
程序员
演员/模特
行政总监
印刷机械机长
服装设计
合伙人
瑜伽/舞蹈老师
自动化工程师
磨工/冲压工
美体师
电子商务
公交/地铁乘务
股票交易员
区域销售经理/主管
教学/教务管理人员
签证专员
生物工程/生物制药
汽车质量管理/检验检测
医学化验/检验
印刷操作
汽车检验/检测
信贷管理/资信评估
市场拓展
证券/期货/外汇经纪人
培训经理/主管
副总裁/副总经理
合同管理
机械维修/保养
部门/事业部管理
日式厨师
普工/技工其他
新媒体运营
市政工程师
针灸/推拿
国际货运
CEO/总裁/总经理
大客户经理
WEB前端开发
公关专员/助理
生产项目经理/主管
店面/陈列/展览设计
人事总监
服装设计师
店铺文案编辑
婚礼策划
园林/景观设计
保健医生
列车乘务
化验/检验
洗车工
咨询顾问
广告文案
维修工程师
财务总监
值班经理
投资/理财顾问
总经理
给排水/制冷/暖通
UI设计
裱花师
生产文员
渠道经理/总监
销售行政专员/助理
投诉专员
环境绿化
工程资料管理
物业管理其他
瓦工
娱乐休闲其他
中餐厨师
会籍顾问
市场经理/总监
高中教师
猎头顾问
游泳教练
工艺设计
律师助理
硬件工程师
生产总监
生产物料管理（PMC）
销售培训师/讲师
服装/纺织/皮革跟单
保健按摩其他
理赔专员/顾问
家政保洁其他
传单派发
团购业务员
餐饮其他
道路桥梁技术
锅炉工
大堂副理
行政主厨
加油站工作员
公务员/事业单位
建筑设计师/制图师
高尔夫球助理
安全管理
渠道/分销经理/主管
信用卡/银行卡业务
技术专员/助理
证券分析/金融研究
货运代理
商务专员
电梯工
活动执行
水泥工
洗头工
客户代表
物业租赁/销售
文科教师
二手车评估师
管道工
助理业务跟单
营养师
制造工程师
生产跟单
物业招商管理
洗衣工
市场策划
医药质检
食品/饮料研发/检验
人力资源总监
培训督导
食品制作工
微信推广
媒介专员/助理
总经理助理
质量管理/测试经理
送水工
人事行政其他
语音/视频/图形
法务专员
测试员
财务其他
业务拓展经理/主管
淘宝运营专员
交通管理员
区域销售总监
买手
装配工艺工程师
电力线路工
原画师
视频主播
彩妆培训师
音效师
通信技术工程师
设备主管
建筑工程验收
产品管理
物流总监
实施工程师
会展策划/设计
业务跟单经理
日语翻译
股票/期货操盘手
Java开发工程师
礼仪/模特
销售数据分析
销售运营经理/主管
灯光师
广告创意
建筑制图
公共区域经理
护理主任/护士长
轮胎工
银行会计/柜员
外贸经理/主管
供应商开发
结构工程师
野外拓展训练师
中医科医生
船员/水手
心理医生
婚礼/庆典策划服务
建筑其他
酒店其他
企业策划
印花工
零配件销售
仪器/仪表/计量
信贷管理/资信评估/分析
网站编辑
房产内勤
医药销售经理/主管
校长
SEO优化
搓澡工
研发工程师
物流仓储其他
测试/可靠性工程师
广告/会展项目管理
电子/电器设备工程师
律师/法律顾问
售前/售后技术支持管理
文编/组稿
培训策划
工厂厂长/副厂长
网络运营专员/助理
保险内勤
纸样师/车板工
预订经理
建筑工程安全管理
销售其他
宠物护理/兽医
VIP专员
工程总监
首席运营官COO
房产客服
市场调研
党工团干事
订单处理员
公共卫生/疾病控制
审计经理/主管
牙科医生
环保检测
幕墙工程师
财务分析员
文案策划
汽车设计工程师
钢筋工
售前/售后技术支持工程师
运动健身其他
家电维修
教育产品开发
教育培训其他
绘画
综合门诊/全科医生
房地产中介/交易
作家/编剧/撰稿人
运营主管
网络与信息安全工程师
综合业务专员/助理
车险专员
装配技师 
台球教练
交通其他
汽车机械工程师
音频/视频工程师
汽车其他
税务经理/主管
人事信息系统(HRIS)管理
礼宾经理
房产店长/经理
超市/零售其他
金融产品销售
装订/烫金
汽车电工
生活配送员
航空乘务
设计管理人员
艺术/设计总监
生产项目工程师
救生员
房产店员/助理
总机员工
大学教师
服装/纺织/皮革工艺师
高级业务跟单
营运主管
空调工
艺人经纪人
销售
信审核查
司机/交通服务
企业秘书/董事会秘书
财务顾问
技工
压熨工
医学影像/放射科医师
资产/资金管理
艺术老师
环境管理/保护
保险客户经理
工艺/珠宝设计
验光师
客服其他
服装/纺织其他
酒店管理
销售行政经理/主管
餐饮
客户主管
移动通信工程师
物流/仓储项目管理
环境工程技术
渠道/分销总监
职业技术教师
运营总监
工程设备管理
测试工程师
学术研究/科研
公关经理/主管
游戏界面设计
宠物护理和美容
客服总监
质检/安防其他
电子技术研发工程师
记者/采编
品酒师
工业设计
空调工程/设计
停车管理员
石油天然气技术人员
房务部总监
安防工程师
经销商
超市/百货/零售
品牌专员/助理
普工/技工
列车驾驶/操作
汽车零部件设计师
服装/纺织品/皮革质量管理
游戏策划
其他房产职位
网店管理员
洗衣房经理
互联网其他
公司业务
媒介策划/管理
版图设计工程师
软装设计师
硬装设计师
IT技术支持/维护工程师
汽车电子工程师
服装/纺织品/皮革销售
企划经理/主管
空调/热能工程师
外汇/基金/国债经理人
园林景观设计师
临床研究/协调
电脑放码员
橱柜设计师
水质检测员
美容美发其他
总工程师/副总工程师
售后服务/客户服务
认证工程师/审核员
保险经纪人
电信网络工程师
染工
饲料业务
化验/检验科医师
医疗器械推广
营运经理
切纸机操作工
开发报建
楼宇自动化 
家政保洁/安保
信用卡销售
短视频剪辑
融资经理/总监
网络运营管理
广告/会展业务拓展
融资专员
业务拓展专员/助理
医药研发/生产/注册
医药学术推广
电子/电器工艺/制程工程师
证券经理/总监
能源/矿产项目管理
动物育种/养殖
吊车司机/卡车司机
产科医生
主持人/司仪
宾客关系主任
场长
运营专员
电气线路设计
数码直印/菲林输出
韩语翻译
媒介销售
集装箱业务
移民/留学咨询
玩具设计
城市规划与设计
餐厅领班
投资者关系
环保技术
公关总监
网站策划
问卷调查
保险客服
销售运营专员/助理
医疗器械研发/维修
发动机/总装工程师
计算机硬件维护工程师
市场主管
报关员
手机软件开发工程师
网络营销
化学实验室技术员/研究员
高级客户经理/客户经理
金融产品经理
房地产销售经理
面料辅料开发/采购
会务会展经理
经纪人/星探
个人业务
储备经理人
收银主管
担保/拍卖/典当
经纪人助理
国际贸易主管
外汇交易
金融服务经理
美容整形科医生
林业技术人员
俄语翻译
无线通信工程师
系统集成工程师
舞台美术设计
选址拓展/新店开发
有线传输工程师
材料工程师
学生兼职
客户总监
养殖部主管
业务分析经理/主管
汽车工程项目管理
工业工程师
技术文档工程师
无线电工程师
川湘菜厨师
动物营养/饲料研发
高级管理其他
会务专员/助理
装订工
法语翻译
化学分析测试员 
环保工程师
房地产销售主管
C语言开发工程师
水处理工程师
资产评估
水利/港口工程技术
考研/公务员培训讲师
喷塑工
固体污水废气处理
嵌入式软件开发
数据库管理/DBA
集成电路/应用工程
合规管理
电子商务总监
医疗器械生产/质量管理
美工/平面设计
专业顾问
会计
人文/社会科学
岩土工程师
质量工程师
园艺师
纺织品设计师
房地产开发/策划
促销主管/督导
安全性能工程师
产品工艺/规划工程师
畜牧师
土建勘察
船舶乘务
化学分析
投资/理财服务
技术总监/经理
插花设计师
安防系统工程师
医药招商 
总机经理
EHS管理
旅游其他
纺织工
证券/投资客户经理
化学操作
激光/光电子技术      
市场调研与分析
医药化学分析
内容运营
产品运营
市场文案策划
外科医生
创意指导/总监
特教(特殊教育)
压痕工
保险电销
调墨技师 
咨询经理/主管
船舶维修/保养
Android开发工程师
化工项目管理
汽车定损/车险理赔
教育培训
饲料销售
整经工
UE设计
灯光/照明设计工程师
房地产资产管理
在线销售
保险核保
化妆品研发
美容/美发
架线和管道工程技术
挡车工
情报信息分析
网站运营总监/经理
科研管理人员
药品市场推广专员/助理
粤港菜厨师
药品市场推广经理/主管
公司业务部门经理/主管
包装工程师
文字编辑/组稿
产品经理
清算人员
出版/发行
物流销售
广告客户总监/经理
ERP技术/开发应用
网店推广
产权/专利顾问
保险顾问
板房/底格出格师
海关事务管理
体系工程师 
生产研发其他
物流/仓储
医院护理其他
船舶设计与制造
汽车代驾
临床数据分析员 
导游
系统架构师
德语翻译
医院/医疗/护理
药品生产/质量管理
船务/空运陆运操作
飞机驾驶/操作
算法工程师
变压器与磁电工程师
电子软件开发
IT技术支持/维护经理
调色员
首席财务官CFO
视频剪辑助理
仿真应用工程师
计算机辅助设计师
网站架构设计师
内科医生
裱胶工
视频剪辑师
科研人员
电子/电气其他
 校长/副校长
促销经理
Flash设计/开发
企业/业务发展经理
外籍教师
法国菜厨师
游戏代练
固定资产会计
电子元器件工程师
服装/纺织设计总监
监察人员
嵌入式硬件开发
媒介经理/主管
微信运营专员
气动工程师
艺人统筹
人事/行政/后勤
健身教练
政府事务管理
品牌策划
银行经理/主任
特效设计
投资经理
农林牧鱼其他
麻醉师
投资银行业务
游戏界面设计师
基金项目经理
保险其他职位
摄影/摄像
环境管理/园林景区保护
楼面管理
医药技术研发人员
硬件测试
续期管理
影视/娱乐/休闲
建筑
系统管理员
美术创意其他
办事处首席代表
演艺演出
脚本开发工程师
模拟电路设计/应用工程师
证券/投资客户总监
国际贸易专员
航空航天
房产评估师
飞机设计与制造
生态治理/规划
信息技术经理/主管
编辑出版其他
淘宝运营主管
线路结构设计
证券/投资客户代表
微信运营主管
东北菜厨师
求职信息
电子商务专员/助理
语音/视频/图形开发
晒版员
视频剪辑专员
IOS开发工程师
手绘/漫画
化工工程师
气象
金融机构
企业律师/合规顾问
电器研发工程师
儿科医生
证券/投资项目管理
个人业务部门经理/主管
法律其他
IT项目执行/协调人员
法务主管
造纸研发
房地产项目管理
移动互联网开发
艺人助理
产品总监
墨西哥菜厨师
保险
数据通信工程师
化学制剂研发
银行
企业律师/合规经理/主管
核力/火电工程师
制药生物其他
短视频运营
云贵菜厨师
FAE 现场应用工程师
医药项目管理
学术推广
意大利菜厨师
保险培训师
保险精算师
翻译
短视频编导
电声/音响工程师/技术员
水运/陆运/空运销售
医药技术研发管理人员
化学技术应用
环境评价工程师
咨询总监
市场/公关/媒介
小龙虾厨师
用户体验（UE/UX）设计
物业顾问
爆破工程师
月嫂阿姨
电信交换工程师
电镀工
集装箱操作
兼职测试
旅游
列车维修/保养
投资银行财务分析
固废处理工程师
招商专员
电气设计
临床推广经理
计算机/互联网/通信
汽车制造/服务
IT技术文员/助理
电子商务经理/主管
造型师/服装师/道具师
院长
水利/水电工程师
客户专员
商务经理/主管
房地产项目招投标
通信电源工程师
创意策划
游戏测试
专科医生
游戏原画
电池/电源开发
SEO/SEM
保险项目经理
品牌/连锁招商管理
需求分析师
汽车机构工程师
信息技术专员
房地产项目开发报建
配色技术员
阿拉伯语翻译
市场运营
网店客服"""
    t = TD(raw)
    t.run()
